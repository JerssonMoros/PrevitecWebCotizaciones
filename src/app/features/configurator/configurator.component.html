<div class="min-h-screen bg-gray-100 p-5">
  <!-- Header -->
  <div class="mb-2">
    <h1 class="text-4xl font-bold text-center mb-4">Diseña tu Máquina</h1>
    <p class="text-center text-gray-600 mb-6">Selecciona las opciones que mejor se adapten a tus necesidades</p>
  </div>
  <div>
    <div class="bg-gray-100 min-h-screen font-sans p-4 flex flex-col items-center w-full">
      <div class="w-full max-w-7xl bg-white rounded-2xl shadow-lg p-8 transition-all duration-300 flex flex-col">
        
        <!-- <header class="text-center mb-8 flex-shrink-0">
          <h1 class="text-3xl font-bold text-gray-800">Mapa de Maquinaria</h1>
          <p class="text-gray-500 mt-2">Seleccione una opción para desplegar el siguiente nivel.</p>
        </header> -->

        <!-- Contenedor del Mapa Mental (Scrollable) -->
        <div #scrollContainer class="flex-grow overflow-x-auto overflow-y-hidden p-4">
          <div class="flex flex-row gap-8 pb-4">
            
            <!-- Renderizado de Niveles -->
            @for (level of computedLevels(); track $index; let levelIndex = $index) {
              <div class="flex flex-col gap-3 flex-shrink-0 w-64 border-l-2 border-gray-200 pl-6">
                <!-- Título del Nivel -->
                <h2 class="text-lg font-semibold text-blue-700 -ml-6 pl-5 py-1 border-l-4 border-blue-700 bg-blue-50">
                  {{ level.title }}
                </h2>
                <!-- Opciones -->
                @for (option of level.options; track option.label) {
                  <button 
                    (click)="handleSelection(option, levelIndex)"
                    [class]="selectionPath()[levelIndex]?.label === option.label 
                      ? 'bg-blue-600 text-white shadow-lg scale-105' 
                      : 'bg-white text-gray-700 hover:bg-gray-50 hover:shadow-md'"
                    class="p-4 rounded-lg shadow-sm border border-gray-200 text-left w-full transition-all duration-200 ease-in-out transform hover:-translate-y-0.5">
                    <span class="text-base font-semibold">{{ option.label }}</span>
                  </button>
                }
              </div>
            }
          </div>
        </div>

        <!-- Mensaje final o Botón de reseteo -->
        @if (isSelectionComplete()) {
          <div #machineInfoDiv class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 flex-shrink-0">
            
            @if (isLoadingMachine()) {
              <!-- Estado de Carga -->
              <div class="py-16 text-center">
                <h3 class="text-2xl font-bold text-gray-700">Buscando máquina...</h3>
                <p class="text-gray-500 mt-2">Simulando petición de red (1 seg)</p>
                <!-- Spinner SVG -->
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mt-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
            } @else {
              <!-- Resultados (una vez que la carga termina) -->
              @if (machineResult(); as machine) {
                
                <!-- (NUEVO) Vista de Configuración de Máquina -->
                <div class="w-full">
                  <h3 class="text-3xl font-bold text-gray-900 mb-6 pb-4 border-b border-gray-300">
                    Configuración: <span class="text-blue-700">{{ machine.name }}</span>
                  </h3>

                  <div class="flex flex-col lg:flex-row gap-8">
                    
                    <!-- Columna Izquierda: Info Base y Totales -->
                    <div class="w-full lg:w-1/3 flex-shrink-0">
                      <div class="sticky top-8 space-y-4">
                        <!-- Info Base -->
                        <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                          <img [src]="machine.imageUrl" alt="Imagen de {{machine.name}}" class="w-full h-64 object-cover">
                          <div class="p-5">
                            <h4 class="text-xl font-bold text-gray-900">{{ machine.name }}</h4>
                            <p class="text-sm font-semibold text-blue-600 mb-3">{{ machine.id }}</p>
                            <p class="text-gray-700 text-sm mb-4">{{ machine.description }}</p>
                            
                            <h5 class="text-lg font-semibold text-gray-800">Precio Base</h5>
                            <p class="text-2xl font-bold text-gray-900">{{ formatPrice(machine.price_cop, 'COP') }}</p>
                            <p class="text-md text-gray-600">{{ formatPrice(machine.price_usd, 'USD') }}</p>
                          </div>
                        </div>

                        <!-- Totales -->
                        <div class="bg-blue-700 text-white rounded-lg shadow-xl p-6">
                          <h4 class="text-2xl font-bold">Total Estimado</h4>
                          <p class="text-4xl font-extrabold mt-2">{{ formatPrice(totalPriceCOP(), 'COP') }}</p>
                          <p class="text-xl font-light opacity-90">{{ formatPrice(totalPriceUSD(), 'USD') }}</p>
                        </div>
                      </div>
                    </div>

                    <!-- Columna Derecha: Opciones -->
                    <div class="w-full lg:w-2/3 space-y-6">
                      
                      <!-- Sección: Equipamiento Adicional -->
                      @if (machine.aditional_equipment.length > 0) {
                        <div class="bg-white rounded-lg shadow border border-gray-200">
                          <header class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h4 class="text-xl font-semibold text-gray-800">Equipamiento Adicional</h4>
                            <label class="flex items-center text-sm font-medium text-gray-700">
                              <input type="checkbox"
                                class="form-checkbox h-4 w-4 rounded text-blue-600 mr-2"
                                [checked]="selectedOptions().aditional.size === machine.aditional_equipment.length"
                                (change)="toggleAll('aditional', $event)"
                              >
                              Seleccionar todo
                            </label>
                          </header>
                          <div class="divide-y divide-gray-100">
                            @for (item of machine.aditional_equipment; track item.name) {
                              <label class="flex items-start gap-4 p-4 hover:bg-gray-50 cursor-pointer">
                                <input 
                                  type="checkbox"
                                  class="form-checkbox h-5 w-5 rounded text-blue-600 mt-1 flex-shrink-0"
                                  [checked]="selectedOptions().aditional.has(item.name)"
                                  (change)="toggleOption('aditional', item.name)"
                                >
                                <div class="flex-grow">
                                  <span class="font-medium text-gray-800">{{ item.name }}</span>
                                  <p class="text-sm text-gray-600">{{ item.description }}</p>
                                </div>
                                <div class="text-right flex-shrink-0 w-32">
                                  <span class="text-sm font-semibold text-gray-900">+ {{ formatPrice(item.price_cop, 'COP') }}</span>
                                  <span class="block text-xs text-gray-500">+ {{ formatPrice(item.price_usd, 'USD') }}</span>
                                </div>
                              </label>
                            }
                          </div>
                        </div>
                      }

                      <!-- Sección: Equipamiento Opcional -->
                      @if (machine.optional_equipment.length > 0) {
                        <div class="bg-white rounded-lg shadow border border-gray-200">
                          <header class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h4 class="text-xl font-semibold text-gray-800">Equipamiento Opcional</h4>
                            <label class="flex items-center text-sm font-medium text-gray-700">
                              <input type="checkbox"
                                class="form-checkbox h-4 w-4 rounded text-blue-600 mr-2"
                                [checked]="selectedOptions().optional.size === machine.optional_equipment.length"
                                (change)="toggleAll('optional', $event)"
                              >
                              Seleccionar todo
                            </label>
                          </header>
                          <div class="divide-y divide-gray-100">
                            @for (item of machine.optional_equipment; track item.name) {
                              <label class="flex items-start gap-4 p-4 hover:bg-gray-50 cursor-pointer">
                                <input 
                                  type="checkbox"
                                  class="form-checkbox h-5 w-5 rounded text-blue-600 mt-1 flex-shrink-0"
                                  [checked]="selectedOptions().optional.has(item.name)"
                                  (change)="toggleOption('optional', item.name)"
                                >
                                <div class="flex-grow">
                                  <span class="font-medium text-gray-800">{{ item.name }}</span>
                                  <p class="text-sm text-gray-600">{{ item.description }}</p>
                                </div>
                                <div class="text-right flex-shrink-0 w-32">
                                  <span class="text-sm font-semibold text-gray-900">+ {{ formatPrice(item.price_cop, 'COP') }}</span>
                                  <span class="block text-xs text-gray-500">+ {{ formatPrice(item.price_usd, 'USD') }}</span>
                                </div>
                              </label>
                            }
                          </div>
                        </div>
                      }

                      <!-- Sección: Servicios y Documentación -->
                      @if (machine.services_documentation.length > 0) {
                        <div class="bg-white rounded-lg shadow border border-gray-200">
                          <header class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h4 class="text-xl font-semibold text-gray-800">Servicios y Documentación</h4>
                            <label class="flex items-center text-sm font-medium text-gray-700">
                              <input type="checkbox"
                                class="form-checkbox h-4 w-4 rounded text-blue-600 mr-2"
                                [checked]="selectedOptions().services.size === machine.services_documentation.length"
                                (change)="toggleAll('services', $event)"
                              >
                              Seleccionar todo
                            </label>
                          </header>
                          <div class="divide-y divide-gray-100">
                            @for (item of machine.services_documentation; track item.name) {
                              <label class="flex items-start gap-4 p-4 hover:bg-gray-50 cursor-pointer">
                                <input 
                                  type="checkbox"
                                  class="form-checkbox h-5 w-5 rounded text-blue-600 mt-1 flex-shrink-0"
                                  [checked]="selectedOptions().services.has(item.name)"
                                  (change)="toggleOption('services', item.name)"
                                >
                                <div class="flex-grow">
                                  <span class="font-medium text-gray-800">{{ item.name }}</span>
                                  <p class="text-sm text-gray-600">{{ item.description }}</p>
                                </div>
                                <div class="text-right flex-shrink-0 w-32">
                                  <span class="text-sm font-semibold text-gray-900">+ {{ formatPrice(item.price_cop, 'COP') }}</span>
                                  <span class="block text-xs text-gray-500">+ {{ formatPrice(item.price_usd, 'USD') }}</span>
                                </div>
                              </label>
                            }
                          </div>
                        </div>
                      }
                      
                    </div>
                  </div>
                </div>

              } @else {
                <!-- Resultado No Encontrado -->
                <div class="py-16 text-center">
                  <h3 class="text-2xl font-bold text-yellow-800">Selección Completa</h3>
                  <p class="text-yellow-700 mt-2">
                    Ha llegado al final de esta ruta.
                    (No se encontró una máquina específica para esta combinación).
                  </p>
                </div>
              }
            }
            
            <!-- Botón de reseteo siempre presente al final -->
            <div class="text-center mt-10">
              <button 
                (click)="reset()"
                class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-lg hover:shadow-xl">
                Comenzar de Nuevo
              </button>
            </div>
          </div>
        } @else if (selectionPath().length > 0) {
           <div class="mt-8 text-center flex-shrink-0">
             <button 
              (click)="reset()"
              class="px-5 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors duration-200">
              Reiniciar Selección
            </button>
           </div>
        }

      </div>
    </div>
  </div>
  
</div>
